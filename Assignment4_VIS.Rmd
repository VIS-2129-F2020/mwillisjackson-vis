---
title: "Assignment4_VIS"
author: "Megan Willis-Jackson"
date: "10/1/2020"
output: html_document
---





```{r load libraries, message=F}
library(osmdata)
library(opentripplanner)
library(tidyverse)
library(sf)
library(ggthemes)
library(ggspatial)
library(raster)
library(units)
library(data.table)


```

```{r load locations}
NOLA_performance <- st_read(
  "https://data.nola.gov/api/geospatial/d7bz-pa33?method=export&format=KML")

nola_neighborhoods<- st_read("https://opendata.arcgis.com/datasets/e7daa4c977d14e1b9e2fa4d7aff81e59_0.kml?outSR=%7B%22latestWkid%22%3A3452%2C%22wkid%22%3A102682%7D")

nola_french<- st_read("https://opendata.arcgis.com/datasets/e7daa4c977d14e1b9e2fa4d7aff81e59_0.kml?where=OBJECTID%20%3E%3D%201077%20AND%20OBJECTID%20%3C%3D%201077&geometry=%7B%22xmin%22%3A-90.247%2C%22ymin%22%3A29.909%2C%22xmax%22%3A-89.813%2C%22ymax%22%3A30.013%2C%22type%22%3A%22extent%22%2C%22spatialReference%22%3A%7B%22wkid%22%3A4326%7D%7D&outSR=%7B%22latestWkid%22%3A3452%2C%22wkid%22%3A102682%7D")

ggplot(nola_french) +
  geom_sf() +
  theme_map()

opq(bbox = 'New Orleans LA USA') %>%
  add_osm_feature(key = 'highway') %>%
  osmdata_xml(file = 'OTP/graphs/default/NOLA_streets.osm')

#opq(bbox = 'New Orleans LA USA') %>%
 # add_osm_feature(key = 'public_transport') %>%
  #osmdata_xml(file = 'OTP/graphs/default/NOLA_transit.osm')


LA_state_plane <- "+proj=lcc +lat_1=30.7 +lat_2=29.3 +lat_0=28.5 +lon_0=-91.33333333333333 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"


```


```{r}

nola_street_features <- opq(bbox = 'New Orleans LA USA') %>%
  add_osm_feature(key = 'highway') %>%
  osmdata_sf()

nola_streets <- nola_street_features$osm_lines %>%
  st_transform(crs = LA_state_plane)

nola_transit_features <- opq(bbox = 'New Orleans LA USA') %>%
  add_osm_feature(key = 'public_transport') %>%
  osmdata_sf()

nola_transit <- nola_transit_features$osm_points %>%
  st_transform(crs = LA_state_plane)

ggplot(NOLA_performance) +
  geom_sf(data = nola_neighborhoods) +
  geom_sf() +
  theme_map()

ggplot(nola_streets) +
  geom_sf() +
  geom_sf(data = nola_transit, color = "red", size = .5) +
  theme_map()

ggplot(nola_transit) +
  geom_sf() +
  theme_map()
```



```{r, message=F, results='hide'}

path_data <- file.path(getwd(), "OTP")
path_otp <- paste(path_data, "otp.jar",sep = "/")

otp_build_graph(otp = path_otp, dir = path_data, memory = 1024) 

otp_setup(otp = path_otp, dir = path_data, memory =1024)

otpcon <- otp_connect()

```


```{r}
nola_french_performance<- NOLA_performance[nola_french,]

iso_nola_french <- otp_isochrone(otpcon = otpcon, fromPlace = nola_french_performance,
                                 mode = "CAR", cutoffSec = 600) %>%
  st_transform(crs = LA_state_plane) %>%
  mutate(mode = "drive")

iso_5min_walk <- 
  otp_isochrone(otpcon = otpcon, fromPlace = NOLA_performance, 
                mode = "WALK", cutoffSec = 300) %>%
  st_transform(crs = LA_state_plane) %>%
  mutate(mode = "walk")

iso_5min_bike <- 
  otp_isochrone(otpcon = otpcon, fromPlace = NOLA_performance, 
                mode = "BICYCLE", cutoffSec = 300) %>%
  st_transform(crs = LA_state_plane) %>%
  mutate(mode = "bike")

iso_all_modes <- rbind(iso_5min_bike, iso_5min_walk)

otp_stop()
```


```{r}

right_side <- st_bbox(iso_nola_french)$xmax+1000
left_side  <- st_bbox(iso_nola_french)$xmin+2000
top_side <- st_bbox(iso_nola_french)$ymax-1000
bottom_side <- st_bbox(iso_nola_french)$ymin+500

ggplot(iso_all_modes) +
  geom_sf(data = nola_streets, color = "grey") +
  geom_sf(aes(fill = mode), color = NA, alpha = 0.5) +
  geom_sf(data = NOLA_performance) +
  coord_sf(xlim = c(left_side, right_side), 
           ylim = c(bottom_side, top_side), expand = FALSE) +
  scale_fill_solarized(name = "Area that is reachable \nwithin 5 minutes",
                       labels = c("By bike", "By foot")) +
  annotation_north_arrow(location = "tl",
                         style = north_arrow_fancy_orienteering(line_col = "black",fill = "black")) +
  annotation_scale(location = "br", bar_cols = c("white","grey")) +
  theme_map() +
  theme(legend.background = element_rect(fill = alpha("white",.5), color = "grey"),
        legend.justification = c(-1.99,-.23),
        legend.title = element_text(face = "bold"),
        legend.title.align = .5) +
  labs(caption = "Basemap Copyright OpenStreetMap contributors")


```

```{r compare isochrone areas}
iso_relevant<- iso_all_modes[iso_nola_french,]

iso_relevant<- iso_relevant %>%
  distinct(fromPlace, .keep_all = T)

iso_areas<- iso_relevant %>%
  mutate(area = set_units(st_area(iso_relevant), km^2)) %>%
  st_set_geometry(NULL) %>%
  pivot_wider(names_from = mode, values_from = area)

ggplot(iso_areas,
       aes(x = as.numeric(walk), y = as.numeric(bike))) +
  geom_point() +
  scale_x_continuous(name = 
                       "\nArea within a five minute walking distance\nof a performance venue (square km)") +
  scale_y_continuous(name = "Area within a five minute biking distance\nof a performance venue (square km)\n") +
  theme_economist()

```


The previous scatter plot shows the accessible area for each performance venue in downtown New Orleans that may be reached in six minutes by bike or on foot. Downtown New Orleans is here defined as any area of NOLA reachable within 10 minutes by car from the French Quarter. I am curious what the total area for each mode is. Summing them in their current form would not answer this specific question, though, because the venues are often very close to each other and overlap in isochrones. Below, I merge the areas by mode to prevent any area from being double counted and subsequently present a bar chart with the total accessible areas by each mode.

```{r total acreage}
total_area_bike<- st_as_sf(st_union(iso_5min_bike$geometry[iso_nola_french,]))

total_area_walk<- st_as_sf(st_union(iso_5min_walk$geometry[iso_nola_french,]))

#why doesn't this work??
ggplot(nola_streets) +
  geom_sf() +
  geom_sf(data = total_area_bike, fill = "seagreen", color = "purple", alpha = .5) +
  geom_sf(data = total_area_walk, fill = "red", alpha = .5) +
  geom_sf(data = NOLA_performance) +
  coord_sf(xlim = c(left_side, right_side), 
           ylim = c(bottom_side, top_side), expand = FALSE) +
  theme_map() +
  labs(caption = "Basemap Copyright OpenStreetMap contributors")


#when this one works (difference is alpha)
ggplot(nola_streets) +
  geom_sf() +
  geom_sf(data = total_area_bike, fill = "seagreen", color = NA) +
  geom_sf(data = total_area_walk, fill = "red", alpha = .5, color = NA) +
  geom_sf(data = NOLA_performance) +
  coord_sf(xlim = c(left_side, right_side), 
           ylim = c(bottom_side, top_side), expand = FALSE) +
  theme_map() +
  labs(caption = "Basemap Copyright OpenStreetMap contributors")
```


```{r }

total_area_bike_sum<- set_units(st_area(total_area_bike), km^2)

total_area_walk_sum<- set_units(st_area(total_area_walk), km^2)

mode_temp<- c("walk area", "bike area")
area_temp<- c(total_area_walk_sum, total_area_bike_sum)
total_area<- data.frame(mode_temp, as.numeric(substr(area_temp,1,8)))
colnames(total_area)<- c("mode", "area")

ggplot(total_area,
       aes(x = mode,
           y = area,
           fill = mode)) +
  geom_col() +
  scale_y_continuous(name = NULL, 
                     labels = NULL, 
                     breaks = NULL) +
  scale_x_discrete(name = "Mode",
                   labels = c("Biking","Walking")) +
  geom_text(label = paste(prettyNum(total_area$area, digits = 3),"sq km"), 
            nudge_y = .4) +
  scale_fill_ordinal() +
  labs(title = "Area Accessible Traveling Five Minutes from a\nPerformance Venue in Downtown New Orleans") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white"),
        plot.title = element_text(hjust = .5), 
        axis.ticks.x = element_blank()) 


```
